version: 2.1

orbs:
  win: circleci/windows@5.0.0

jobs:
  build:
    executor:
      name: win/default
      size: medium
    
    steps:
      - checkout
      
      - run:
          name: Install WiX Toolset (for MSI installer)
          shell: powershell.exe
          command: |
            Write-Host "Installing WiX Toolset for MSI creation..."
            choco install wix --version 3.11.2 -y --no-progress
            if ($LASTEXITCODE -ne 0) {
              Write-Host "Chocolatey not available, trying direct download..."
              # WiX will be installed via alternative method if needed
            }
            $env:Path += ";C:\Program Files (x86)\WiX Toolset v3.11\bin"
            
      - run:
          name: Restore NuGet packages
          shell: powershell.exe
          command: |
            nuget restore PhishingReporter.sln
            
      - run:
          name: Build solution and installer (Release)
          shell: powershell.exe
          command: |
            $msbuild = "C:\Program Files\Microsoft Visual Studio\2022\Community\MSBuild\Current\Bin\MSBuild.exe"
            if (-not (Test-Path $msbuild)) {
              $msbuild = "C:\Program Files (x86)\Microsoft Visual Studio\2019\Community\MSBuild\Current\Bin\MSBuild.exe"
            }
            if (-not (Test-Path $msbuild)) {
              $msbuild = "C:\Program Files (x86)\Microsoft Visual Studio\2017\Community\MSBuild\15.0\Bin\MSBuild.exe"
            }
            
            if (Test-Path $msbuild) {
              Write-Host "Building PhishingReporter project..."
              & $msbuild PhishingReporter\PhishingReporter.csproj /t:Build /p:Configuration=Release /p:Platform="Any CPU" /v:minimal
              
              Write-Host "Building Installer project..."
              # Try to build installer using devenv or MSBuild
              $devenv = "C:\Program Files\Microsoft Visual Studio\2022\Community\Common7\IDE\devenv.com"
              if (-not (Test-Path $devenv)) {
                $devenv = "C:\Program Files (x86)\Microsoft Visual Studio\2019\Community\Common7\IDE\devenv.com"
              }
              if (-not (Test-Path $devenv)) {
                $devenv = "C:\Program Files (x86)\Microsoft Visual Studio\2017\Community\Common7\IDE\devenv.com"
              }
              
              if (Test-Path $devenv) {
                & $devenv PhishingReporter.sln /Build Release
              } else {
                Write-Host "⚠️  Installer project requires Visual Studio IDE. Building DLL only."
                Write-Host "   Installer can be built manually in Visual Studio."
              }
            } else {
              Write-Host "MSBuild not found. Trying with msbuild command..."
              msbuild PhishingReporter.sln /t:Build /p:Configuration=Release /p:Platform="Any CPU" /v:minimal
            }
            
      - run:
          name: Verify build output and package installer
          shell: powershell.exe
          command: |
            if (Test-Path "PhishingReporter\bin\Release\PhishingReporter.dll") {
              Write-Host "✅ DLL Build successful!"
              Get-Item "PhishingReporter\bin\Release\PhishingReporter.dll" | Select-Object Name, Length, LastWriteTime
              Get-ChildItem "PhishingReporter\bin\Release\" | Select-Object Name, Length
            } else {
              Write-Host "❌ Build failed - DLL not found"
              Get-ChildItem "PhishingReporter\bin\" -Recurse -ErrorAction SilentlyContinue | Select-Object FullName
              exit 1
            }
            
            Write-Host ""
            Write-Host "Building MSI installer with WiX..."
            
            # Build MSI using WiX
            $wixPath = "C:\Program Files (x86)\WiX Toolset v3.11\bin"
            $candle = "$wixPath\candle.exe"
            $light = "$wixPath\light.exe"
            
            if (Test-Path $candle) {
              Write-Host "Compiling WiX source..."
              & $candle Installer\PhishingReporter.wxs -out Installer\PhishingReporter.wixobj
              
              if ($LASTEXITCODE -eq 0) {
                Write-Host "Linking MSI..."
                & $light Installer\PhishingReporter.wixobj -out Installer\PhishingReporter-Setup.msi
                
                if (Test-Path "Installer\PhishingReporter-Setup.msi") {
                  Write-Host "✅ MSI installer created: Installer\PhishingReporter-Setup.msi"
                  Get-Item "Installer\PhishingReporter-Setup.msi" | Select-Object Name, Length
                }
              }
            } else {
              Write-Host "⚠️  WiX not found. Creating PowerShell-based installer..."
              # Use PowerShell script to create installer
              if (Test-Path "Installer\create_installer.ps1") {
                & powershell -ExecutionPolicy Bypass -File "Installer\create_installer.ps1" -OutputPath "Installer\PhishingReporter-Setup.exe"
                if (Test-Path "Installer\PhishingReporter-Setup.exe") {
                  Write-Host "✅ Standalone installer created"
                }
              }
            }
            
            # Also check for existing installers
            $installerPaths = @(
              "Installer\Release\PhishingReporter-Setup.exe",
              "Installer\Release\*.msi",
              "Installer\Release\*.exe",
              "Installer\PhishingReporter-Setup.msi"
            )
            
            $foundInstaller = $false
            foreach ($path in $installerPaths) {
              $files = Get-ChildItem $path -ErrorAction SilentlyContinue
              if ($files) {
                Write-Host "✅ Installer found: $($files.FullName)"
                $foundInstaller = $true
              }
            }
            
      - store_artifacts:
          path: PhishingReporter/bin/Release
          destination: dll-artifacts
          
      - store_artifacts:
          path: Installer/Release
          destination: installer-artifacts
          
      - run:
          name: Create SCCM deployment package
          shell: powershell.exe
          command: |
            $packageDir = "SCCM_Deployment"
            New-Item -ItemType Directory -Force -Path $packageDir | Out-Null
            
            # Copy all necessary files
            if (Test-Path "PhishingReporter\bin\Release") {
              Copy-Item "PhishingReporter\bin\Release\*" -Destination "$packageDir\Files" -Recurse -Force
            }
            
            # Create SCCM installation script
            @"
@echo off
REM Phishing Reporter - SCCM Deployment Script
REM Silent installation for enterprise deployment

setlocal
set INSTALL_DIR=%ProgramFiles%\PhishingReporter
set OUTLOOK_VERSION=

REM Detect Outlook version
for /f "tokens=*" %%i in ('reg query "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Office" /s /f "Outlook" 2^>nul ^| findstr /i "Version"') do (
    set OUTLOOK_VERSION=%%i
)

if "%OUTLOOK_VERSION%"=="" (
    echo ERROR: Microsoft Outlook not detected
    exit /b 1
)

REM Create installation directory
if not exist "%INSTALL_DIR%" mkdir "%INSTALL_DIR%"

REM Copy files
xcopy /Y /I "%~dp0Files\*" "%INSTALL_DIR%\"

REM Register add-in (VSTO specific)
REM Note: May require VSTO runtime and proper registration

echo Phishing Reporter installed successfully
exit /b 0
"@ | Out-File -FilePath "$packageDir\install.cmd" -Encoding ASCII
            
            # Create uninstall script
            @"
@echo off
REM Phishing Reporter - Uninstall Script for SCCM

set INSTALL_DIR=%ProgramFiles%\PhishingReporter

if exist "%INSTALL_DIR%" (
    rmdir /S /Q "%INSTALL_DIR%"
    echo Phishing Reporter uninstalled
) else (
    echo Phishing Reporter not found
)

exit /b 0
"@ | Out-File -FilePath "$packageDir\uninstall.cmd" -Encoding ASCII
            
            # Create deployment instructions
            @"
SCCM / Group Policy Deployment Instructions
===========================================

1. Package Contents:
   - Files\ : All DLL and dependencies
   - install.cmd : Silent installation script
   - uninstall.cmd : Uninstallation script

2. SCCM Deployment:
   - Create new Application in SCCM
   - Set install command: install.cmd
   - Set uninstall command: uninstall.cmd
   - Detection method: Check for %ProgramFiles%\PhishingReporter\PhishingReporter.dll

3. Group Policy Deployment:
   - Copy package to network share
   - Create GPO with startup script pointing to install.cmd
   - Or use Software Installation policy

4. Requirements:
   - Microsoft Outlook (2013 or later)
   - .NET Framework 4.6.1 or later
   - VSTO Runtime (usually pre-installed with Office)

5. Silent Installation:
   install.cmd

6. Verification:
   Check Outlook Add-ins: File > Options > Add-ins
   Look for "Phishing Reporter" in Active Application Add-ins
"@ | Out-File -FilePath "$packageDir\DEPLOYMENT_README.txt" -Encoding ASCII
            
            Write-Host "✅ SCCM deployment package created in: $packageDir"
            Get-ChildItem $packageDir -Recurse | Select-Object FullName
            
      - store_artifacts:
          path: SCCM_Deployment
          destination: sccm-package

workflows:
  build-workflow:
    jobs:
      - build

