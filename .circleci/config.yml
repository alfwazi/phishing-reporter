version: 2.1

orbs:
  win: circleci/windows@5.0.0

jobs:
  build:
    executor:
      name: win/default
      size: medium
    
    steps:
      - checkout
      
      - run:
          name: Install WiX Toolset (for MSI installer)
          shell: powershell.exe
          command: |
            Write-Host "Installing WiX Toolset for MSI creation..."
            choco install wix --version 3.11.2 -y --no-progress
            if ($LASTEXITCODE -ne 0) {
              Write-Host "Chocolatey not available, trying direct download..."
              # WiX will be installed via alternative method if needed
            }
            $env:Path += ";C:\Program Files (x86)\WiX Toolset v3.11\bin"
            
      - run:
          name: Restore NuGet packages
          shell: powershell.exe
          command: |
            nuget restore PhishingReporter.sln
            
      - run:
          name: Generate temporary certificate for signing (if needed)
          shell: powershell.exe
          command: |
            if (-not (Test-Path "PhishingReporter\PhishingReporter_TemporaryKey.pfx")) {
              Write-Host "Generating temporary certificate for ClickOnce signing..."
              $cert = New-SelfSignedCertificate -Subject "CN=PhishingReporter" -CertStoreLocation Cert:\CurrentUser\My -KeyExportPolicy Exportable -KeySpec Signature -KeyLength 2048 -KeyAlgorithm RSA -HashAlgorithm SHA256 -NotAfter (Get-Date).AddYears(1)
              $pwd = ConvertTo-SecureString -String "temp123" -Force -AsPlainText
              Export-PfxCertificate -Cert $cert -FilePath "PhishingReporter\PhishingReporter_TemporaryKey.pfx" -Password $pwd
              Write-Host "✅ Temporary certificate created"
            } else {
              Write-Host "Certificate file already exists"
            }
            
      - run:
          name: Build solution and installer (Release)
          shell: powershell.exe
          command: |
            $msbuild = "C:\Program Files\Microsoft Visual Studio\2022\Community\MSBuild\Current\Bin\MSBuild.exe"
            if (-not (Test-Path $msbuild)) {
              $msbuild = "C:\Program Files (x86)\Microsoft Visual Studio\2019\Community\MSBuild\Current\Bin\MSBuild.exe"
            }
            if (-not (Test-Path $msbuild)) {
              $msbuild = "C:\Program Files (x86)\Microsoft Visual Studio\2017\Community\MSBuild\15.0\Bin\MSBuild.exe"
            }
            
            if (Test-Path $msbuild) {
              Write-Host "Building PhishingReporter solution..."
              # Build the solution file - this sets all output paths correctly
              & $msbuild PhishingReporter.sln /t:Build /p:Configuration=Release /p:Platform="Any CPU" /v:minimal /m
              
              if ($LASTEXITCODE -ne 0) {
                Write-Host "Build failed, checking for errors..."
                exit 1
              }
              
              Write-Host "✅ Solution built successfully"
            } else {
              Write-Host "MSBuild not found. Trying with msbuild command..."
              msbuild PhishingReporter.sln /t:Build /p:Configuration=Release /p:Platform="Any CPU" /v:minimal /m
              if ($LASTEXITCODE -ne 0) {
                exit 1
              }
            }
            
      - run:
          name: Verify build output and package installer
          shell: powershell.exe
          command: |
            if (Test-Path "PhishingReporter\bin\Release\PhishingReporter.dll") {
              Write-Host "✅ DLL Build successful!"
              Get-Item "PhishingReporter\bin\Release\PhishingReporter.dll" | Select-Object Name, Length, LastWriteTime
              Get-ChildItem "PhishingReporter\bin\Release\" | Select-Object Name, Length
            } else {
              Write-Host "❌ Build failed - DLL not found"
              Get-ChildItem "PhishingReporter\bin\" -Recurse -ErrorAction SilentlyContinue | Select-Object FullName
              exit 1
            }
            
            Write-Host ""
            Write-Host "Building MSI installer with WiX..."
            
            # Build MSI using WiX
            $wixPath = "C:\Program Files (x86)\WiX Toolset v3.11\bin"
            $candle = "$wixPath\candle.exe"
            $light = "$wixPath\light.exe"
            
            if (Test-Path $candle) {
              Write-Host "Compiling WiX source..."
              & $candle Installer\PhishingReporter.wxs -out Installer\PhishingReporter.wixobj
              
              if ($LASTEXITCODE -eq 0) {
                Write-Host "Linking MSI..."
                & $light Installer\PhishingReporter.wixobj -out Installer\PhishingReporter-Setup.msi
                
                if (Test-Path "Installer\PhishingReporter-Setup.msi") {
                  Write-Host "✅ MSI installer created: Installer\PhishingReporter-Setup.msi"
                  Get-Item "Installer\PhishingReporter-Setup.msi" | Select-Object Name, Length
                }
              }
            } else {
              Write-Host "⚠️  WiX not found. Trying Inno Setup..."
              # Create PowerShell-based installer (guaranteed to work)
              Write-Host "Creating PowerShell-based installer..."
              $installerDir = "Installer\Release"
              New-Item -ItemType Directory -Force -Path $installerDir | Out-Null
              
              # Create self-extracting installer script
              $installerScript = @'
@echo off
REM Phishing Reporter Outlook Add-in - Silent Installer
REM Generated by CircleCI Build

setlocal
set INSTALL_DIR=%ProgramFiles%\PhishingReporter
set SCRIPT_DIR=%~dp0

echo Installing Phishing Reporter Outlook Add-in...
echo.

REM Check if Outlook is running
tasklist /FI "IMAGENAME eq OUTLOOK.EXE" 2>NUL | find /I /N "OUTLOOK.EXE">NUL
if "%ERRORLEVEL%"=="0" (
    echo ERROR: Outlook is running. Please close Outlook before installation.
    pause
    exit /b 1
)

REM Create installation directory
if not exist "%INSTALL_DIR%" mkdir "%INSTALL_DIR%"

REM Copy files
echo Copying files...
xcopy /Y /I "%SCRIPT_DIR%Files\*" "%INSTALL_DIR%\" /E /Q

if %ERRORLEVEL% NEQ 0 (
    echo ERROR: Failed to copy files.
    pause
    exit /b %ERRORLEVEL%
)

REM Register the VSTO Add-in
echo Registering Outlook Add-in...
"%ProgramFiles%\Common Files\Microsoft Shared\VSTO\10.0\VSTOInstaller.exe" /Install "%INSTALL_DIR%\PhishingReporter.vsto" /Silent

if %ERRORLEVEL% NEQ 0 (
    echo WARNING: VSTO registration may have failed. Add-in may need manual registration.
) else (
    echo Phishing Reporter Add-in installed successfully!
)

echo.
echo Installation complete!
pause
'@
              
              # Create Files subdirectory and copy DLLs
              $filesDir = Join-Path $installerDir "Files"
              New-Item -ItemType Directory -Force -Path $filesDir | Out-Null
              Copy-Item -Path "PhishingReporter\bin\Release\*" -Destination $filesDir -Recurse -Force
              
              # Save installer script
              $installerScript | Out-File -FilePath (Join-Path $installerDir "install.cmd") -Encoding ASCII
              
              # Create a simple batch file that can be renamed to .exe if needed
              # For now, create a ZIP file that can be extracted and run
              $zipFile = Join-Path "Installer" "PhishingReporter-Setup.zip"
              Compress-Archive -Path "$installerDir\*" -DestinationPath $zipFile -Force
              
              Write-Host "✅ PowerShell-based installer created:"
              Write-Host "   - Installer package: $zipFile"
              Write-Host "   - Installation script: $installerDir\install.cmd"
              Get-Item $zipFile | Select-Object Name, Length
              
              # Also try Inno Setup if available (optional)
              if (Test-Path "is.exe") {
                Write-Host ""
                Write-Host "Attempting Inno Setup (optional)..."
                Push-Location "Installer"
                try {
                  $isPath = Resolve-Path "..\is.exe"
                  $issPath = "PhishingReporter.iss"
                  $process = Start-Process -FilePath $isPath -ArgumentList "/cc", "/O+", "/Q", "/SILENT", $issPath -Wait -PassThru -NoNewWindow
                  if ($process.ExitCode -eq 0 -and (Test-Path "Release\PhishingReporter-Setup.exe")) {
                    Copy-Item "Release\PhishingReporter-Setup.exe" -Destination "..\Installer\Release\" -Force -ErrorAction SilentlyContinue
                    Write-Host "✅ Inno Setup installer also created"
                  }
                } catch {
                  Write-Host "⚠️  Inno Setup failed (non-critical)"
                } finally {
                  Pop-Location
                }
              }
              } else {
                Write-Host "Creating PowerShell-based installer..."
                # Use PowerShell script to create installer
                if (Test-Path "Installer\create_installer.ps1") {
                  & powershell -ExecutionPolicy Bypass -File "Installer\create_installer.ps1" -OutputPath "Installer\PhishingReporter-Setup.exe"
                  if (Test-Path "Installer\PhishingReporter-Setup.exe") {
                    Write-Host "✅ Standalone installer created"
                  }
                }
              }
            }
            
            # Verify installer was created
            if (Test-Path "Installer\PhishingReporter-Setup.zip") {
              Write-Host "✅ Installer package ready: Installer\PhishingReporter-Setup.zip"
            }
            if (Test-Path "Installer\Release\PhishingReporter-Setup.exe") {
              Write-Host "✅ Inno Setup installer also available: Installer\Release\PhishingReporter-Setup.exe"
            }
            
      - store_artifacts:
          path: PhishingReporter/bin/Release
          destination: dll-artifacts
          
      - store_artifacts:
          path: Installer/Release
          destination: installer-artifacts
          
      - run:
          name: Copy MSI installer to artifacts if created
          shell: powershell.exe
          command: |
            if (Test-Path "Installer\PhishingReporter-Setup.msi") {
              Write-Host "✅ MSI installer found, copying to Release folder for artifacts..."
              Copy-Item "Installer\PhishingReporter-Setup.msi" -Destination "Installer\Release\" -Force -ErrorAction SilentlyContinue
            }
            if (Test-Path "Installer\PhishingReporter-Setup.exe") {
              Write-Host "✅ EXE installer found, copying to Release folder for artifacts..."
              Copy-Item "Installer\PhishingReporter-Setup.exe" -Destination "Installer\Release\" -Force -ErrorAction SilentlyContinue
            }
          
      - run:
          name: Create SCCM deployment package
          shell: powershell.exe
          command: |
            $packageDir = "SCCM_Deployment"
            New-Item -ItemType Directory -Force -Path $packageDir | Out-Null
            
            # Copy all necessary files
            if (Test-Path "PhishingReporter\bin\Release") {
              Copy-Item "PhishingReporter\bin\Release\*" -Destination "$packageDir\Files" -Recurse -Force
            }
            
            # Create SCCM installation script
            $installScript = "echo off`n"
            $installScript += "REM Phishing Reporter - SCCM Deployment Script`n"
            $installScript += "REM Silent installation for enterprise deployment`n`n"
            $installScript += "setlocal`n"
            $installScript += "set INSTALL_DIR=%ProgramFiles%\\PhishingReporter`n"
            $installScript += "set OUTLOOK_VERSION=`n`n"
            $installScript += "REM Detect Outlook version`n"
            $installScript += "for /f `"tokens=*`" %%%%i in ('reg query `"HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Office`" /s /f `"Outlook`" 2^>nul ^| findstr /i `"Version`"') do (`n"
            $installScript += "    set OUTLOOK_VERSION=%%%%i`n"
            $installScript += ")`n`n"
            $installScript += "if `"%OUTLOOK_VERSION%`"==`"`" (`n"
            $installScript += "    echo ERROR: Microsoft Outlook not detected`n"
            $installScript += "    exit /b 1`n"
            $installScript += ")`n`n"
            $installScript += "REM Create installation directory`n"
            $installScript += "if not exist `"%INSTALL_DIR%`" mkdir `"%INSTALL_DIR%`"`n`n"
            $installScript += "REM Copy files`n"
            $installScript += "xcopy /Y /I `"%~dp0Files\\*`" `"%INSTALL_DIR%\\`"`n`n"
            $installScript += "REM Register add-in (VSTO specific)`n"
            $installScript += "REM Note: May require VSTO runtime and proper registration`n`n"
            $installScript += "echo Phishing Reporter installed successfully`n"
            $installScript += "exit /b 0`n"
            $installScript | Out-File -FilePath "$packageDir\install.cmd" -Encoding ASCII
            
            # Create uninstall script
            $uninstallScript = "echo off`n"
            $uninstallScript += "REM Phishing Reporter - Uninstall Script for SCCM`n`n"
            $uninstallScript += "set INSTALL_DIR=%ProgramFiles%\\PhishingReporter`n`n"
            $uninstallScript += "if exist `"%INSTALL_DIR%`" (`n"
            $uninstallScript += "    rmdir /S /Q `"%INSTALL_DIR%`"`n"
            $uninstallScript += "    echo Phishing Reporter uninstalled`n"
            $uninstallScript += ") else (`n"
            $uninstallScript += "    echo Phishing Reporter not found`n"
            $uninstallScript += ")`n`n"
            $uninstallScript += "exit /b 0`n"
            $uninstallScript | Out-File -FilePath "$packageDir\uninstall.cmd" -Encoding ASCII
            
            # Create deployment instructions
            $readmeText = "SCCM / Group Policy Deployment Instructions`n"
            $readmeText += "===========================================`n`n"
            $readmeText += "1. Package Contents:`n"
            $readmeText += "   - Files\\ : All DLL and dependencies`n"
            $readmeText += "   - install.cmd : Silent installation script`n"
            $readmeText += "   - uninstall.cmd : Uninstallation script`n`n"
            $readmeText += "2. SCCM Deployment:`n"
            $readmeText += "   - Create new Application in SCCM`n"
            $readmeText += "   - Set install command: install.cmd`n"
            $readmeText += "   - Set uninstall command: uninstall.cmd`n"
            $readmeText += "   - Detection method: Check for %ProgramFiles%\\PhishingReporter\\PhishingReporter.dll`n`n"
            $readmeText += "3. Group Policy Deployment:`n"
            $readmeText += "   - Copy package to network share`n"
            $readmeText += "   - Create GPO with startup script pointing to install.cmd`n"
            $readmeText += "   - Or use Software Installation policy`n`n"
            $readmeText += "4. Requirements:`n"
            $readmeText += "   - Microsoft Outlook (2013 or later)`n"
            $readmeText += "   - .NET Framework 4.6.1 or later`n"
            $readmeText += "   - VSTO Runtime (usually pre-installed with Office)`n`n"
            $readmeText += "5. Silent Installation:`n"
            $readmeText += "   install.cmd`n`n"
            $readmeText += "6. Verification:`n"
            $readmeText += "   Check Outlook Add-ins: File > Options > Add-ins`n"
            $readmeText += "   Look for `"Phishing Reporter`" in Active Application Add-ins`n"
            $readmeText | Out-File -FilePath "$packageDir\DEPLOYMENT_README.txt" -Encoding ASCII
            
            Write-Host "✅ SCCM deployment package created in: $packageDir"
            Get-ChildItem $packageDir -Recurse | Select-Object FullName
            
      - store_artifacts:
          path: SCCM_Deployment
          destination: sccm-package

workflows:
  build-workflow:
    jobs:
      - build

